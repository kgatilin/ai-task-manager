# Project Architecture

**Generated by go-arch-lint on 2025-10-18**

## Table of Contents
- [Project Structure](#project-structure)
- [Architectural Rules](#architectural-rules)
- [Dependency Graph](#dependency-graph)
- [Public API](#public-api)
- [Statistics](#statistics)

---

## Project Structure

Required directories as defined in `.goarchlint`:

### internal/infra
**Purpose**: Infrastructure implementations (DB, external APIs, messaging)

**Allowed dependencies**: internal/domain

**Status**: ✓ Exists

---

### cmd
**Purpose**: Application entry points

**Allowed dependencies**: internal/app, internal/infra

**Status**: ✓ Exists

---

### internal/app
**Purpose**: Application services, use cases, orchestration

**Allowed dependencies**: internal/domain

**Status**: ✓ Exists

---

### internal/domain
**Purpose**: Core business logic, entities, value objects, domain services

**Allowed dependencies**: None (isolated layer)

**Status**: ✓ Exists

---

---

## Architectural Rules

From `.goarchlint`:

```yaml
structure:
  required_directories:
    cmd: "Application entry points"
    internal/app: "Application services, use cases, orchestration"
    internal/domain: "Core business logic, entities, value objects, domain services"
    internal/infra: "Infrastructure implementations (DB, external APIs, messaging)"
  allow_other_directories: true

rules:
  directories_import:
    cmd: [internal/app, internal/infra]
    internal/app: [internal/domain]
    internal/domain: []
    internal/infra: [internal/domain]
  detect_unused: true
```

**Validation Status**: ✓ No violations found

---

## Dependency Graph

Detailed method-level dependencies between files:

### cmd/dw/claude.go
**Package**: main

**Local Dependencies**:
- internal/app
  - DefaultDBPath
  - EventMapper
  - HookInputData
  - NewLoggerService
  - NewSetupService
- internal/infra
  - NewContextDetector
  - NewHookConfigManager
  - NewSQLiteEventRepository
  - NewTranscriptParser
  - NormalizeContent
  - ParseHookInput

**External Dependencies**:
- bytes
  - NewReader
- context
  - Background
- fmt
  - Fprintf
  - Fprintln
  - Println
  - Sscanf
- io
  - NopCloser
  - ReadAll
- os
  - Exit
  - Getenv
  - Stderr
  - Stdin

---

### cmd/dw/logs.go
**Package**: main

**Local Dependencies**:
- internal/app
  - DefaultDBPath
  - FormatLogRecord
  - FormatQueryValue
  - LogsService
  - NewLogsService
- internal/infra
  - NewSQLiteEventRepository

**External Dependencies**:
- context
  - Background
  - Context
- flag
  - ContinueOnError
  - NewFlagSet
- fmt
  - Fprintf
  - Print
  - Printf
  - Println
- os
  - Exit
  - IsNotExist
  - Stat
  - Stderr

---

### cmd/dw/main.go
**Package**: main

**Local Dependencies**: None

**External Dependencies**:
- fmt
  - Fprintf
  - Println
- os
  - Args
  - Exit
  - Stderr

---

### internal/app/logger.go
**Package**: app

**Local Dependencies**:
- internal/domain
  - ChatMessageAssistant
  - ChatMessageUser
  - ChatPayload
  - ChatStarted
  - ContextChanged
  - Error
  - EventRepository
  - EventType
  - FileRead
  - FileWritten
  - NewEvent
  - ToolInvoked
  - ToolPayload
  - ToolResult

**External Dependencies**:
- context
  - Context
- encoding/json
  - Marshal
- fmt
  - Errorf
- strings
  - ReplaceAll
  - ToLower

---

### internal/app/logs.go
**Package**: app

**Local Dependencies**:
- internal/domain
  - EventQuery
  - EventRepository
  - QueryResult
  - RawQueryExecutor

**External Dependencies**:
- context
  - Context
- encoding/json
  - Marshal
  - MarshalIndent
  - RawMessage
  - Unmarshal
- fmt
  - Errorf
  - Sprintf
- time
  - Time
  - UnixMilli

---

### internal/app/setup.go
**Package**: app

**Local Dependencies**:
- internal/domain
  - EventRepository

**External Dependencies**:
- context
  - Context
- fmt
  - Errorf
- os
  - MkdirAll
- path/filepath
  - Dir

---

### internal/domain/event.go
**Package**: domain

**Local Dependencies**: None

**External Dependencies**:
- encoding/json
  - Marshal
- time
  - Now
  - Time
- github.com/google/uuid
  - New

---

### internal/domain/repository.go
**Package**: domain

**Local Dependencies**: None

**External Dependencies**:
- context
  - Context
- time
  - Time

---

### internal/domain/trigger.go
**Package**: domain

**Local Dependencies**: None

**External Dependencies**: None

---

### internal/infra/context.go
**Package**: infra

**Local Dependencies**: None

**External Dependencies**:
- os
  - Getenv
  - Getwd
  - Stat
- path/filepath
  - Base
  - Dir
  - Join
- strings
  - TrimSpace

---

### internal/infra/hook_config.go
**Package**: infra

**Local Dependencies**: None

**External Dependencies**:
- encoding/json
  - Marshal
  - MarshalIndent
  - Unmarshal
- fmt
  - Errorf
- os
  - IsNotExist
  - MkdirAll
  - ReadFile
  - Stat
  - WriteFile
- path/filepath
  - Dir

---

### internal/infra/hook_input.go
**Package**: infra

**Local Dependencies**: None

**External Dependencies**:
- encoding/json
  - Unmarshal
- io
  - ReadAll
  - Reader

---

### internal/infra/sqlite_repository.go
**Package**: infra

**Local Dependencies**:
- internal/domain
  - Event
  - EventQuery
  - EventType
  - QueryResult

**External Dependencies**:
- context
  - Context
- database/sql
  - DB
  - Open
- encoding/json
  - RawMessage
  - Unmarshal
- fmt
  - Errorf
  - Sprintf
- strings
  - Join
- time
  - Millisecond
  - Time
  - Unix
- github.com/mattn/go-sqlite3

---

### internal/infra/transcript.go
**Package**: infra

**Local Dependencies**: None

**External Dependencies**:
- bufio
  - NewScanner
- encoding/json
  - Marshal
  - Unmarshal
- fmt
  - Errorf
- os
  - Open
- strings
  - TrimSpace

---

## Public API

Exported interfaces and types available for consumption:

### main

---

### app

#### Types

**EventMapper** `EventMapper`

**MapEventType** `(*EventMapper) MapEventType(string) domain.EventType`

**TranscriptParser** `TranscriptParser`

**ContextDetector** `ContextDetector`

**ContentNormalizer** `ContentNormalizer`

**HookInputData** `HookInputData`
- Properties:
  - SessionID string
  - TranscriptPath string
  - CWD string
  - HookEventName string

**LoggerService** `LoggerService`

**NewLoggerService** `NewLoggerService(domain.EventRepository, TranscriptParser, ContextDetector, ContentNormalizer) *LoggerService`

**LogEvent** `(*LoggerService) LogEvent(context.Context, domain.EventType, interface{}) error`

**LogFromHookInput** `(*LoggerService) LogFromHookInput(context.Context, HookInputData, domain.EventType, int) error`

**Close** `(*LoggerService) Close() error`

#### Types

**LogRecord** `LogRecord`
- Properties:
  - ID string
  - Timestamp time.Time
  - EventType string
  - Payload json.RawMessage
  - Content string

**LogsService** `LogsService`

**NewLogsService** `NewLogsService(domain.EventRepository, domain.RawQueryExecutor) *LogsService`

**ListRecentLogs** `(*LogsService) ListRecentLogs(context.Context, int) ([]*LogRecord, error)`

**ExecuteRawQuery** `(*LogsService) ExecuteRawQuery(context.Context, string) (*domain.QueryResult, error)`

**FormatLogRecord** `FormatLogRecord(int, *LogRecord) string`

**FormatQueryValue** `FormatQueryValue(interface{}) string`

#### Types

**DefaultDBPath** `DefaultDBPath`

**HookConfigManager** `HookConfigManager`

**SetupService** `SetupService`

**NewSetupService** `NewSetupService(domain.EventRepository, HookConfigManager) *SetupService`

**Initialize** `(*SetupService) Initialize(context.Context, string) error`

**GetSettingsPath** `(*SetupService) GetSettingsPath() string`

---

### domain

#### Types

**EventType** `EventType`

**ChatStarted** `ChatStarted`

**ChatMessageUser** `ChatMessageUser`

**ChatMessageAssistant** `ChatMessageAssistant`

**ToolInvoked** `ToolInvoked`

**ToolResult** `ToolResult`

**FileRead** `FileRead`

**FileWritten** `FileWritten`

**ContextChanged** `ContextChanged`

**Error** `Error`

**Event** `Event`
- Properties:
  - ID string
  - Timestamp time.Time
  - Type EventType
  - Payload interface{}
  - Content string

**NewEvent** `NewEvent(EventType, interface{}, string) *Event`

**MarshalPayload** `(*Event) MarshalPayload() ([]byte, error)`

**ChatPayload** `ChatPayload`
- Properties:
  - Message string
  - Context string

**ToolPayload** `ToolPayload`
- Properties:
  - Tool string
  - Parameters string
  - Result string
  - DurationMs int64
  - Context string

**FilePayload** `FilePayload`
- Properties:
  - FilePath string
  - Changes string
  - DurationMs int64
  - Context string

**ContextPayload** `ContextPayload`
- Properties:
  - Context string
  - Description string

**ErrorPayload** `ErrorPayload`
- Properties:
  - Error string
  - StackTrace string
  - Context string

#### Types

**EventRepository** `EventRepository`

**EventQuery** `EventQuery`
- Properties:
  - StartTime *time.Time
  - EndTime *time.Time
  - EventTypes []EventType
  - Context string
  - SearchText string
  - Limit int
  - Offset int

**QueryResult** `QueryResult`
- Properties:
  - Columns []string
  - Rows [][]interface{}

**RawQueryExecutor** `RawQueryExecutor`

#### Types

**TriggerType** `TriggerType`

**TriggerPreToolUse** `TriggerPreToolUse`

**TriggerPostToolUse** `TriggerPostToolUse`

**TriggerNotification** `TriggerNotification`

**TriggerUserPromptSubmit** `TriggerUserPromptSubmit`

**TriggerStop** `TriggerStop`

**TriggerSubagentStop** `TriggerSubagentStop`

**TriggerPreCompact** `TriggerPreCompact`

**TriggerSessionStart** `TriggerSessionStart`

**TriggerSessionEnd** `TriggerSessionEnd`

---

### infra

#### Types

**ContextDetector** `ContextDetector`

**NewContextDetector** `NewContextDetector() *ContextDetector`

**DetectContext** `(*ContextDetector) DetectContext() string`

**NormalizeContent** `NormalizeContent(string) string`

#### Types

**HookConfig** `HookConfig`
- Properties:
  - Hooks map[string][]HookMatcher

**HookMatcher** `HookMatcher`
- Properties:
  - Matcher string
  - Hooks []HookAction

**HookAction** `HookAction`
- Properties:
  - Type string
  - Command string
  - Timeout int

**DefaultDarwinFlowConfig** `DefaultDarwinFlowConfig() HookConfig`

**MergeHookConfigs** `MergeHookConfigs(HookConfig) HookConfig`

**HookConfigManager** `HookConfigManager`

**NewHookConfigManager** `NewHookConfigManager() (*HookConfigManager, error)`

**ClaudeSettings** `ClaudeSettings`
- Properties:
  - Hooks map[string][]HookMatcher
  - Other map[string]interface{}

**ReadSettings** `(*HookConfigManager) ReadSettings() (*ClaudeSettings, error)`

**WriteSettings** `(*HookConfigManager) WriteSettings(*ClaudeSettings) error`

**InstallDarwinFlowHooks** `(*HookConfigManager) InstallDarwinFlowHooks() error`

**GetSettingsPath** `(*HookConfigManager) GetSettingsPath() string`

#### Types

**HookInput** `HookInput`
- Properties:
  - SessionID string
  - TranscriptPath string
  - CWD string
  - HookEventName string

**ParseHookInput** `ParseHookInput(io.Reader) (*HookInput, error)`

#### Types

**SQLiteEventRepository** `SQLiteEventRepository`

**NewSQLiteEventRepository** `NewSQLiteEventRepository(string) (*SQLiteEventRepository, error)`

**Initialize** `(*SQLiteEventRepository) Initialize(context.Context) error`

**Save** `(*SQLiteEventRepository) Save(context.Context, *domain.Event) error`

**FindByQuery** `(*SQLiteEventRepository) FindByQuery(context.Context, domain.EventQuery) ([]*domain.Event, error)`

**Close** `(*SQLiteEventRepository) Close() error`

**ExecuteRawQuery** `(*SQLiteEventRepository) ExecuteRawQuery(context.Context, string) (*domain.QueryResult, error)`

#### Types

**TranscriptEntry** `TranscriptEntry`
- Properties:
  - Role string
  - Content string
  - Type string
  - Name string
  - Parameters map[string]interface{}
  - Input map[string]interface{}

**TranscriptParser** `TranscriptParser`

**NewTranscriptParser** `NewTranscriptParser() *TranscriptParser`

**Parse** `(*TranscriptParser) Parse(string) ([]TranscriptEntry, error)`

**ExtractLastToolUse** `(*TranscriptParser) ExtractLastToolUse(string, int) (string, string, error)`

**ExtractLastUserMessage** `(*TranscriptParser) ExtractLastUserMessage(string) (string, error)`

**ExtractLastAssistantMessage** `(*TranscriptParser) ExtractLastAssistantMessage(string) (string, error)`

---

## Statistics

- **Total Files**: 14
- **Total Packages**: 4
- **Required Directories**: 4/4 present
- **Violations**: 0
- **External Dependencies**: 14

---

*This documentation is auto-generated. To regenerate: `go-arch-lint -format=full .` or `go-arch-lint -format=docs .`*
